<!DOCTYPE html>
<html lang="en">



<head>
  
  <meta charset="UTF-8" />
  <meta
    name="description"
    content="Sense Math Notation  $s(t)$ the scale at the time $t$, i.e. the price of the Target token in the underlying token terms at the time moment $t$ $\theta$ The tilt value, i."
  />
  <title>
    lonerapier.xyz
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
  <meta property="og:url" content="https://lonerapier.xyz" />
  <meta property="og:title" content="" />
  <meta property="og:description" content="" />
  <meta property="og:image" content="https://jzhao.xyz/res/og-card.png" />
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@lonerapier">
  <meta name="twitter:title" content="">
  <meta name="twitter:description" content="" />
  <meta name="twitter:image" content="https://jzhao.xyz/res/og-card.png" />

  
  
  
  
  
  <link rel="shortcut icon" type="image/png"  href="https://dsam82.github.io//icon.png" />
  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    
    
  
  
  <link href="https://dsam82.github.io/styles.992fdc3c531684dcd8502f0024614203.min.css" rel="stylesheet" />

  
  <link href="https://dsam82.github.io/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css" rel="stylesheet" id="theme-link">

   
  
  
  
  
  <script src="https://dsam82.github.io/js/darkmode.99bf74b17084665b02e60f42b67a6c02.min.js"></script>
  
  
  
  <script src="https://dsam82.github.io/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js"></script>
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>



  <script src="https://unpkg.com/@floating-ui/core@0.7.3"></script>
  <script src="https://unpkg.com/@floating-ui/dom@0.5.4"></script>
  
  <script src="https://dsam82.github.io/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js"></script>

  
  
  
  <script src="https://dsam82.github.io/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js"></script>
  

  
  
  <script src="https://dsam82.github.io/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js"></script>
  

  
  
  <script src="https://dsam82.github.io/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js"></script>
  

  
   
  <script>
    
    const isReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
    const lastVisit = localStorage.getItem('lastVisitTime')
    const now = Date.now()
    let show = 'true'
    if (lastVisit) {
      document.documentElement.setAttribute('visited', 'true')
      const minElapsed = Math.ceil((now - parseInt(lastVisit)) / (1000 * 60))
      show = (!isReducedMotion && minElapsed > 5) ? 'true' : 'false'
    }
    document.documentElement.setAttribute('show-animation', show)
    localStorage.setItem('lastVisitTime', `${now}`)

    const BASE_URL = "https://dsam82.github.io/"
    const fetchData = Promise.all([
          fetch("https:\/\/dsam82.github.io\/indices\/linkIndex.38c5cc7e3870b3f3ba1b02252dd1103d.min.json")
            .then(data => data.json())
            .then(data => ({
              index: data.index,
              links: data.links,
            })),
          fetch("https:\/\/dsam82.github.io\/indices\/contentIndex.4715aefbc575583d0a9861488ff8e57a.min.json")
            .then(data => data.json()),
        ])
        .then(([{index, links}, content]) => ({
          index,
          links,
          content,
        }))

      const render = () => {
      

      const siteBaseURL = new URL(BASE_URL);
      const pathBase = siteBaseURL.pathname;
      const pathWindow = window.location.pathname;
      const isHome = pathBase == pathWindow;

      addCopyButtons();
      

      addTitleToCodeBlocks();
      

      addCollapsibleCallouts();
      

      
      initPopover(
        "https://dsam82.github.io",
         true ,
         true 
      )
      

      
      const footer = document.getElementById("footer")
      if (footer) {
        const container = document.getElementById("graph-container")
        
        if (!container) return requestAnimationFrame(render)
        
        container.textContent = ""

        const drawGlobal = isHome &&  false ;
        drawGraph(
            "https://dsam82.github.io",
            drawGlobal,
            [{"/moc":"#4388cc"}],
            drawGlobal ? {"centerForce":1,"depth":-1,"enableDrag":true,"enableLegend":false,"enableZoom":true,"fontSize":0.5,"linkDistance":1,"opacityScale":3,"repelForce":1,"scale":1.4} : {"centerForce":1,"depth":1,"enableDrag":true,"enableLegend":false,"enableZoom":true,"fontSize":0.6,"linkDistance":1,"opacityScale":3,"repelForce":2,"scale":1.2}
          );

        }
      
    }

    const init = (doc = document) => {
      
      addCopyButtons();
      

      addTitleToCodeBlocks();
      renderMathInElement(doc.body, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false},
        ],
        throwOnError : false
      });
      
    };
  </script>
  
  
  <script type="module">
    import { attachSPARouting } from "https:\/\/dsam82.github.io\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script>
  
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-XYFD95KB4J', { 'anonymize_ip': false });
}
</script>



<body>
<div id="search-container">
  <div id="search-space">
    <input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search"
      placeholder="Search for something..." dir="">
    <div id="results-container">
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js"
  integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin="anonymous" defer></script>

<script defer src="https://dsam82.github.io/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js"></script>



<div class="singlePage">
    
    <header class="delay t-3">
  <h1 id="page-title"><a href="https://dsam82.github.io/">lonerapier.xyz</a></h1>
  <div class="spacer"></div>
  <div id="search-icon">
    <p>Search</p>
    <svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg>
  </div>
  <div class='darkmode'>
    <input class='toggle' id='darkmode-toggle' type='checkbox' tabindex="-1">
    <label id="toggle-label-light" for='darkmode-toggle' tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35;" xml:space="preserve">
            <title>Light Mode</title>
            <path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z" />
        </svg>
    </label>
    <label id="toggle-label-dark" for='darkmode-toggle' tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'" xml:space="preserve">
            <title>Dark Mode</title>
            <path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z" />
        </svg>
    </label>
</div>
</header>


    <article>
      
      <p class="meta">
        Last updated 
Sep 2, 2022

 
          
<a href="https://github.com/dsam82/dsam82.github.io//posts/fixed%20rate%20protocols/sense-math.md" rel="noopener">Edit Source</a>


      </p>
      <ul class="tags">
          
      </ul>
      
<aside class="mainTOC">
    <details >
        <summary>Table of Contents</summary>
        <nav id="TableOfContents">
  <ol>
    <li><a href="#notation">Notation</a></li>
    <li><a href="#issue">Issue</a></li>
    <li><a href="#redeem">Redeem</a>
      <ol>
        <li><a href="#ideal-case">Ideal Case</a></li>
        <li><a href="#real-case">Real Case</a></li>
        <li><a href="#sunny-day">Sunny Day</a></li>
        <li><a href="#not-so-sunny-day">Not So Sunny Day</a></li>
        <li><a href="#sunny-day-condition">Sunny Day Condition</a></li>
        <li><a href="#the-final-formulas">The Final Formulas</a></li>
        <li><a href="#the-current-formula">The Current Formula</a></li>
      </ol>
    </li>
    <li><a href="#add-liquidity">Add Liquidity</a>
      <ol>
        <li><a href="#target-leftrightarrow-zero-pool">Target $\leftrightarrow$ Zero Pool</a></li>
        <li><a href="#underlying-leftrightarrow-zero-pool">Underlying $\leftrightarrow$ Zero Pool</a></li>
        <li><a href="#the-current-formula-1">The Current Formula</a></li>
        <li><a href="#sell-claim-mode">Sell Claim Mode</a></li>
      </ol>
    </li>
  </ol>
</nav>
    </details>
</aside>


      






  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  














  
  
  
  
  
  
  
  
  
  


<a href="#sense-math"><h1 id="sense-math"><span class="hanchor" ariaLabel="Anchor"># </span>Sense Math</h1></a>
<a href="#notation"><h2 id="notation"><span class="hanchor" ariaLabel="Anchor"># </span>Notation</h2></a>
<dl>
<dt>$s(t)$</dt>
<dd>the scale at the time $t$, i.e. the price of the Target token in the underlying token terms at the time moment $t$</dd>
<dt>$\theta$</dt>
<dd>The tilt value, i.e. the part of the principal that belong to Claims</dd>
<dt>$t_0$</dt>
<dd>The issue time</dd>
<dt>$t_m$</dt>
<dd>The maturity time</dd>
<dt>$S(t)$</dt>
<dd>The maximum scale value earnings were collected at up until the time moment $t$</dd>
<dt>$x$</dt>
<dd>The amount of the Target token being deposited by a user</dd>
<dt>$X$</dt>
<dd>The effective amount of the Target token being deposited</dd>
<dt>$\Delta x$</dt>
<dd>The addition amount of the Target token, collected during issuance and added to the amount deposited by the user</dd>
<dt>$y$</dt>
<dd>An amount of Zero or Claim token</dd>
<dt>$x_z$</dt>
<dd>The ideal amount of the Target token redeemed by a Zero holder</dd>
<dt>$X_z$</dt>
<dd>The actual amount of the Target token redeemed by a Zero holder</dd>
<dt>$x_c$</dt>
<dd>The ideal total amount of the Target token redeemed by a Claim holder</dd>
<dt>$x&rsquo;_c$</dt>
<dd>The ideal amount of the Target token redeemable by a Claim holder before maturity</dd>
<dt>$x&rsquo;&rsquo;_c$</dt>
<dd>The ideal amount of the Target token redeemable by a Claim holder after maturity</dd>
<dt>$X_c$</dt>
<dd>The actual total amount of the Target token redeemed by a Claim holder</dd>
<dt>$X&rsquo;&rsquo;_c$</dt>
<dd>The actual amount of the Target token redeemable by a Claim holder after maturity</dd>
</dl>
<a href="#issue"><h2 id="issue"><span class="hanchor" ariaLabel="Anchor"># </span>Issue</h2></a>
<p>At the time moment $t_0$, a user deposits $x$ amount of the Target token.  He gets: $y = x \cdot s(t_0)$ units of Zero token, and the same amount of Claim token.</p>
<p>In case $s(t_0) &lt; S(t_0)$ the user may immediately collect a certain amount of the Target tokens from just issued Claim token.  It would be reasonable to consider this addition amount of the Target token to be added to the original deposited amount.  The exact additional amount could be found from the following equation:</p>
<p>$$
\Delta x = (x + \Delta x) \cdot s(t_0) \cdot \left( \frac{1}{s(t_0)} - \frac{1}{S(t_0)} \right) = (x + \Delta x) \cdot \left( 1 - \frac{s(t_0)}{S(t_0)} \right) \\\Delta x \left( 1 - \left( 1 - \frac{s(t_0)}{S(t_0)} \right) \right) = x \cdot \left( 1 - \frac{s(t_0)}{S(t_0)} \right) \\\Delta x \cdot \frac{s(t_0)}{S(t_0)} = x \cdot \left( 1 - \frac{s(t_0)}{S(t_0)} \right) \\\Delta x = \frac{x \cdot \left( 1 - \frac{s(t_0)}{S(t_0)} \right)}{\frac{s(t_0)}{S(t_0)}} = x \cdot \left( \frac{S(t_0)}{s(t_0)} - 1 \right)
$$</p>
<p>So the full deposited amount is:</p>
<p>$$
X = x + \Delta x = x + x \cdot \left( \frac{S(t_0)}{s(t_0)} - 1 \right) = x \cdot \frac{S(t_0)}{s(t_0)}
$$</p>
<p>and the full amount of issued tokens (the same for Zero and Claim tokens) is:</p>
<p>$$
Y = X \cdot s(t_0) = x \cdot \frac{S(t_0)}{s(t_0)} \cdot s(t_0) = x \cdot S(t_0)
$$</p>
<p>Note, that the outcome for the user is as if the current scale was $S(t_0)$ rather than $s(t_0)$. Thus is would be reasonable for the protocol to use the current max scale instead of the current scale when calculating the number of Zeros and Claim to be issued.</p>
<p>In case the user already have some amount of Claim token when issuing more tokens, earnings should be collected from these Claim token amount before issuing more Claim token.  Let&rsquo;s assume that the user already has the amount $Y_l$ of Claim token and earnings were last colected at the time $t_l$. Then the user may collect the following amount $x_l$ of Target token from his existing Claim holdings:</p>
<p>$$
x_l = Y_l \cdot \left( \frac{1}{s(t_l)} - \frac{1}{S(t_0)} \right)
$$</p>
<p>Thus the full amount of issued tokens, that takes into account the collected earnings from existing Claim holdings, is:</p>
<p>$$
Y = \left( x + Y_l \cdot \left( \frac{1}{s(t_l)} - \frac{1}{S(t_0)} \right) \right) \cdot S(t_0)
$$</p>
<a href="#redeem"><h2 id="redeem"><span class="hanchor" ariaLabel="Anchor"># </span>Redeem</h2></a>
<a href="#ideal-case"><h3 id="ideal-case"><span class="hanchor" ariaLabel="Anchor"># </span>Ideal Case</h3></a>
<p>In the ideal case, when a user redeems $y$ amount of Zero token, he gets the following amount of the Target token:</p>
<p>$$
x_z =
y\frac{(1 - \theta)}{s(t_m)}
$$</p>
<p>In the ideal case, when a user redeems $y$ amount of Claim token, he gets the following total amount of the Target token:</p>
<p>$$
x_c =
y\left( \frac{\theta}{s(t_m)} + \frac{1}{s(t_0)} - \frac{1}{s(t_m)} \right) =
y \left( \frac{1}{s(t_0)} - \frac{(1 - \theta)}{s(t_m)} \right)
$$</p>
<p>Note that:</p>
<p>$$
x_z + x_c =
\frac{y}{s(t_0)} =
\frac{x \cdot s(t_0)}{s(t_0)} =
x
$$</p>
<p>i.e. the whole deposited amount is redeemed.</p>
<a href="#real-case"><h3 id="real-case"><span class="hanchor" ariaLabel="Anchor"># </span>Real Case</h3></a>
<p>The following amount could be collected by Claim token holders before maturity:</p>
<p>$$
x&rsquo;_c =
y\left( \frac{1}{s(t_0)} - \frac{1}{S(t_m)} \right)
$$</p>
<p>So the following amount is to be collected after maturity:</p>
<p>$$
x&rsquo;&rsquo;_c =
x_c - x&rsquo;_c =
y\left( \frac{1}{s(t_0)} - \frac{(1 - \theta)}{s(t_m)} \right) - y\left( \frac{1}{s(t_0)} - \frac{y}{(t_m)} \right) = y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right)
$$</p>
<p>As it is impossible to collect a negative amount, the actual amount collected after maturity is:</p>
<p>$$
X&rsquo;&rsquo;_c =
\max (0, x&rsquo;&rsquo;_c) =
\max \left( 0, y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \right)
$$</p>
<p>Thus the actual total amount of the Target tokens got by the Claim token hoder is:</p>
<p>$$
X_c =
x&rsquo;_c + X&rsquo;&rsquo;_c =
y\left( \frac{1}{s(t_0)} - \frac{1}{S(t_m)} \right) + \max \left( 0, y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \right)
$$</p>
<p>and the actual amount of the Target tokens got by the Zero token holder is:</p>
<p>$$
X_z =
x - X_c =
\frac{y}{s(t_0)} - y\left( \frac{1}{s(t_0)} - \frac{1}{S(t_m)} \right) - \max \left( 0, y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \right) =\=
y\left( \frac{1}{S(t_m)} - \max \left( 0, \left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \right) \right)
$$</p>
<a href="#sunny-day"><h3 id="sunny-day"><span class="hanchor" ariaLabel="Anchor"># </span>Sunny Day</h3></a>
<p>When</p>
<p>$$
y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \geqslant 0
$$</p>
<p>we have:</p>
<p>$$
X_c =
y\left( \frac{1}{s(t_0)} - \frac{1}{S(t_m)} \right) + \max \left( 0, y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \right) =\=
y\left( \frac{1}{s(t_0)} - \frac{1}{S(t_m)} \right) + y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) =\=
y\left( \frac{1}{s(t_0)} - \frac{(1 - \theta)}{s(t_m)} \right) = x_c
$$</p>
<p>$$
X_z =
y\left( \frac{1}{S(t_m)} - \max \left( 0, \left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \right) \right) =\=
y\left( \frac{1}{S(t_m)} - \left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \right) =\=
y \frac{(1 - \theta)}{s(t_m)} = x_z
$$</p>
<p>So, in a sunny day scenario, $X_z = x_z$ and $X_c = x_c$.</p>
<a href="#not-so-sunny-day"><h3 id="not-so-sunny-day"><span class="hanchor" ariaLabel="Anchor"># </span>Not So Sunny Day</h3></a>
<p>When the day is not so sunny, i.e.</p>
<p>$$
y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) &lt; 0
$$</p>
<p>we have:</p>
<p>$$
X_c =
y\left( \frac{1}{s(t_0)} - \frac{1}{S(t_m)} \right) + \max \left( 0, y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \right) =\=
y\left( \frac{1}{s(t_0)} - \frac{1}{S(t_m)} \right) + 0 =\=
y\left( \frac{1}{s(t_0)} - \frac{1}{S(t_m)} \right)
$$</p>
<p>$$
X_z =
y\left( \frac{1}{S(t_m)} - \max \left( 0, \left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \right) \right) =\=
y\left( \frac{1}{S(t_m)} - 0 \right) =\=
\frac{y}{S(t_m)}
$$</p>
<a href="#sunny-day-condition"><h3 id="sunny-day-condition"><span class="hanchor" ariaLabel="Anchor"># </span>Sunny Day Condition</h3></a>
<p>Lets transform the sunny day condition a bit:</p>
<p>$$
y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) \geqslant 0 \\\frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \geqslant 0 \\s(t_m) - S(t_m) \cdot (1 - \theta) \geqslant 0 \\s(t_m) \geqslant S(t_m) \cdot (1 - \theta) \\\frac{s(t_m)}{S(t_m)} \geqslant 1 - \theta
$$</p>
<a href="#the-final-formulas"><h3 id="the-final-formulas"><span class="hanchor" ariaLabel="Anchor"># </span>The Final Formulas</h3></a>
<p>So, the final formulas are:</p>
<p>Zero token holders get the following amount of the Target tokens after maturity:</p>
<p>$$
X_z =
\begin{cases}
y \frac{(1 - \theta)}{s(t_m)} &amp; \text{if} &amp; \frac{s(t_m)}{S(t_m)} \geqslant 1 - \theta, \\\frac{y}{S(t_m)} &amp; \text{if} &amp; \frac{s(t_m)}{S(t_m)} &lt; 1 - \theta
\end{cases}
$$</p>
<p>Claim token holders get the following mount of the Target token after maturity:</p>
<p>$$
X&rsquo;&rsquo;_c =
\begin{cases}
y\left( \frac{1}{S(t_m)} - \frac{(1 - \theta)}{s(t_m)} \right) &amp; \text{if} &amp; \frac{s(t_m)}{S(t_m)} \geqslant 1 - \theta, \\0 &amp; \text{if} &amp; \frac{s(t_m)}{S(t_m)} &lt; 1 - \theta
\end{cases}
$$</p>
<p>Claim token holders get the following total amount of the Target tokens:</p>
<p>$$
X_c =
\begin{cases}
y\left( \frac{1}{s(t_0)} - \frac{(1 - \theta)}{s(t_m)} \right) &amp; \text{if} &amp; \frac{s(t_m)}{S(t_m)} \geqslant 1 - \theta, \\y\left( \frac{1}{s(t_0)} - \frac{1}{S(t_m)} \right) &amp; \text{if} &amp; \frac{s(t_m)}{S(t_m)} &lt; 1 - \theta
\end{cases}
$$</p>
<hr>
<a href="#the-current-formula"><h3 id="the-current-formula"><span class="hanchor" ariaLabel="Anchor"># </span>The Current Formula</h3></a>
<p>$$
X&rsquo;&rsquo;_c = \max \left( 0, y \cdot \frac{\theta}{S(t_m)} - \left( y \cdot \frac{1 - \theta}{s(t_m)} - y \cdot \frac{1 - \theta}{S(t_m)} \right) \right)
$$</p>
<a href="#add-liquidity"><h2 id="add-liquidity"><span class="hanchor" ariaLabel="Anchor"># </span>Add Liquidity</h2></a>
<a href="#target-leftrightarrow-zero-pool"><h3 id="target-leftrightarrow-zero-pool"><span class="hanchor" ariaLabel="Anchor"># </span>Target $\leftrightarrow$ Zero Pool</h3></a>
<p>A user wants to provide the amount $x$ of a Target token as liquidity to a Balancer pool that trades this Target token against a Zero token derived from this Target token.</p>
<p>The user splits the oritinal Target amount into two parts: $x = x&rsquo; + x&rsquo;&rsquo;$.  The first part $x&rsquo;$ goes directly to the pool.  The second part $x&rsquo;&rsquo;$ is used to issue Zero that will go to the pool.  The amount of Zero issued is:</p>
<p>$$
y = x&rsquo;&rsquo; \cdot S(t)
$$</p>
<p>Let $X$ be the pool reserves of the Target token, and $Y$ be the pool reserves of Zero.  The user needs to provide the tokens at the same proportion, so:</p>
<p>$$
\frac{x&rsquo;}{y} = \frac{X}{Y} \\\frac{x&rsquo;}{x&rsquo;&rsquo; \cdot S(t)} = \frac{X}{Y} \\\frac{x - x&rsquo;&rsquo;}{x&rsquo;&rsquo; \cdot S(t)} = \frac{X}{Y} \\(x - x&rsquo;&rsquo;) \cdot Y = x&rsquo;&rsquo; \cdot S(t) \cdot X \\x \cdot Y = x&rsquo;&rsquo; \cdot \left( S(t) \cdot X + Y \right) \\x&rsquo;&rsquo; = x \cdot \frac{Y}{S(t) \cdot X + Y}
$$</p>
<a href="#underlying-leftrightarrow-zero-pool"><h3 id="underlying-leftrightarrow-zero-pool"><span class="hanchor" ariaLabel="Anchor"># </span>Underlying $\leftrightarrow$ Zero Pool</h3></a>
<p>A user wants to provide the amount $x$ of a Target token as liquidity to a Balancer pool that trades the Underlying token of this Target token to a Zero token derived from this Target token.</p>
<p>The user splits the oritinal amount into two parts: $x = x&rsquo; + x&rsquo;&rsquo;$.  The first part $x&rsquo;$ is redeemed for the Underlying token.  The amount of obtained underlying token is:</p>
<p>$$
z = x&rsquo; \cdot s(t)
$$</p>
<p>The second part $x&rsquo;&rsquo;$ is used to issue Zero that will go to the pool.  The amount of Zero issued is:</p>
<p>$$
y = x&rsquo;&rsquo; \cdot S(t)
$$</p>
<p>Let $Z$ be the pool reserves of the Underlying token, and $Y$ be the pool reserves of Zero.  The user needs to provide the tokens at the same proportion, so:</p>
<p>$$
\frac{z}{y} = \frac{Z}{Y} \\\frac{x&rsquo; \cdot s(t)}{x&rsquo;&rsquo; \cdot S(t)} = \frac{Z}{Y} \\\frac{(x - x&rsquo;&rsquo;) \cdot s(t)}{x&rsquo;&rsquo; \cdot S(t)} = \frac{Z}{Y} \\(x - x&rsquo;&rsquo;) \cdot s(t) \cdot Y = x&rsquo;&rsquo; \cdot S(t) \cdot Z \\x \cdot s(t) \cdot Y = x&rsquo;&rsquo; \cdot \left( S(t) \cdot Z + Y \right) \\x&rsquo;&rsquo; = x \cdot \frac{s(t) \cdot Y}{S(t) \cdot Z + s(t) \cdot Y}
$$</p>
<hr>
<a href="#the-current-formula-1"><h3 id="the-current-formula-1"><span class="hanchor" ariaLabel="Anchor"># </span>The Current Formula</h3></a>
<p>$$
x&rsquo;&rsquo; = x \cdot \frac{Y}{X + Y}
$$</p>
<a href="#sell-claim-mode"><h3 id="sell-claim-mode"><span class="hanchor" ariaLabel="Anchor"># </span>Sell Claim Mode</h3></a>
<ol>
<li>A user provides amount $x$ of the Target token</li>
<li>The amount is split into two parts: $x&rsquo;$ and $x&rsquo;&rsquo;$: $x = x&rsquo; + x&rsquo;'$</li>
<li>The $x&rsquo;&rsquo;$ amount is used to issue an amount $y$ of Zero and the same amount $y$ or Claim</li>
<li>The $x&rsquo;$ amount of Target and $y$ amount of Zero are put into the pool</li>
<li>The pool return the amount $z$ of the LP token</li>
<li>The returned LP token amount is sent to the user</li>
<li>&hellip; so far so good &hellip;</li>
<li>Some amount of the Target token is borrowed</li>
<li>The borrowed Target tokens are used to buy the amount $y$ of Zero from the pool (we just put this amount of Zero into the pool and now bying it back!)</li>
<li>The amount $y$ of Zero and the same amount $y$ of Claim are combined into the amount $x&rsquo;$ of Target (we just split and now recombine!)</li>
<li>A part of the proceeds from recombining is used to repay the debt</li>
<li>The rest proceeds of recombining are returned to the user (the user just provided some amount of Target token, and now we return part of it!)</li>
</ol>
<p>The whole schema is more or less equivalent to this one:</p>
<ol>
<li>A user provides amount $x$ of the Target token</li>
<li>The amount is split into two parts: $x&rsquo;$ and $x&rsquo;&rsquo;$: $x = x&rsquo; + x&rsquo;'$</li>
<li>The $x&rsquo;&rsquo;$ amount is used to buy an amount $y$ of Zero from the pool</li>
<li>The $x&rsquo;$ amount of Target and $y$ amount of Zero are put into the pool</li>
<li>The pool return the amount $z$ of the LP token</li>
<li>The returned LP token amount is sent to the user</li>
</ol>


    </article>
    <hr/>


<div class="page-end" id="footer">
    <div class="backlinks-container">
        <h3>Backlinks</h3>
<ul class="backlinks">
    
    
    
    
    
    
    
    <li>
      No backlinks found
    </li>
    
</ul>

    </div>
    <div>
        <script
  src="https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js"
  integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI="
  crossorigin="anonymous"
></script>
<h3>Interactive Graph</h3>
<div id="graph-container"></div>
<style>
  :root {
    --g-node: var(--secondary);
    --g-node-active: var(--primary);
    --g-node-inactive: var(--visited);
    --g-link: var(--outlinegray);
    --g-link-active: #5a7282;
  }
</style>

<script src="https://dsam82.github.io/js/graph.abd4bc2af3869a96524d7d23b76152c7.js"></script>

    </div>
</div>






<div id="contact_buttons">
    <footer>
        
        
        <p>Made by Sambhav <lonerapier> using <a href="https://github.com/jackyzha0/quartz">Quartz</a>, © 2022</p>
        <ul>
            
            <li><a href="https://dsam82.github.io/">Home</a></li>
            <li><a href="https://twitter.com/lonerapier">Twitter</a></li><li><a href="https://github.com/dsam82">Github</a></li></ul>
    </footer>
</div>


</div>
</body>
</html>
